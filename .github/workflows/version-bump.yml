name: Version Bump

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'backend/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bump-version:
    runs-on: ubuntu-latest
    # Prevent infinite loops: don't run if the commit was made by the bot
    if: "!contains(github.event.head_commit.message, 'chore: bump version')"
    outputs:
      bumped: ${{ steps.bump.outputs.bumped }}
      version: ${{ steps.bump.outputs.new_version }}
      tag: ${{ steps.bump.outputs.new_tag }}
      new_sha: ${{ github.sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required to access git history

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Configure Git
        run: |
          git config user.name "velann21"
          git config user.email "velann21@gmail.com"

      - name: Bump Version
        id: bump
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            go run scripts/bump_version.go --path . --tag-prefix v
          else
            # Feature branch: Dry run and append prerelease tag
            SHORT_SHA=$(git rev-parse --short HEAD)
            SAFE_BRANCH=$(echo "${{ github.ref_name }}" | tr / - | tr -cd '[:alnum:]-')
            SUFFIX="-${SAFE_BRANCH}.${SHORT_SHA}"
            
            go run scripts/bump_version.go --path . --tag-prefix v --dry-run --prerelease-suffix "$SUFFIX"
          fi

      - name: Push Tag
        if: steps.bump.outputs.bumped == 'true' && github.ref == 'refs/heads/main'
        run: |
          git tag ${{ steps.bump.outputs.new_tag }}
          git push origin ${{ steps.bump.outputs.new_tag }}

  publish-backend:
    needs: bump-version
    if: needs.bump-version.outputs.bumped == 'true'
    uses: ./.github/workflows/backend-publish.yml
    with:
      ref: ${{ needs.bump-version.outputs.new_sha }}
      version: ${{ needs.bump-version.outputs.version }}
    secrets: inherit

  publish-frontend:
    needs: bump-version
    if: needs.bump-version.outputs.bumped == 'true'
    uses: ./.github/workflows/frontend-publish.yml
    with:
      ref: ${{ needs.bump-version.outputs.new_sha }}
      version: ${{ needs.bump-version.outputs.version }}
    secrets: inherit
